<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:qc="http://java.sun.com/jsf/composite/quizconnect"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                template="/WEB-INF/templates/main.xhtml">

    <ui:define name="title">#{profileBean.player.user.equals(sessionInfoBean.currentUser) ? 'Home' : 'Profile'}</ui:define>

    <ui:define name="site-specific-css">
        <link rel="stylesheet" type="text/css" href="../resources/profile.css" />
        <script type="text/javascript" src="../resources/quizconnect/js/QCUpload.js"></script>
    </ui:define>

    <ui:define name ="content">

        <!-- // TODO fix update after game (redirect to login redirect) -> use get param if player home !! -->

        <h:form id="form">

            <!-- error handling if player is null -->
            <h:panelGroup layout="block" styleClass="container" rendered="#{profileBean.player == null}">
                <div class="text-center">
                    <p>No player found</p>
                    <h:commandButton styleClass="btn btn-primary" action="all?faces-redirect=true" value="All Players"/>
                </div>
            </h:panelGroup>

            <ui:fragment rendered="#{profileBean.player != null}">

                <h:panelGroup id="player" layout="block" styleClass="profile-grid">

                    <div class="box player-box-info">
                        <div class="box-actions">
                            <h:commandLink rendered="#{profileBean.player.user.equals(sessionInfoBean.currentUser)}"
                                           styleClass="box-action icon" p:data-toggle="modal" p:data-target="#changeAvatar"
                                           p:data-backdrop="static">
                                <i data-feather="image"></i>
                                <f:ajax execute="@this" render=":modals:changeAvatar:body :modals:changeAvatar:footer" />
                            </h:commandLink>

                            <h:commandLink styleClass="box-action icon" p:data-toggle="modal" p:data-target="#deletePlayer"
                                           rendered="#{allPlayersBean.isDeletable(profileBean.player)}">
                                <i data-feather="trash"></i>
                                <f:ajax execute="@this" render="@none"/>
                                <f:setPropertyActionListener value="#{profileBean.player}" target="#{playerDetailController.player}"/>
                            </h:commandLink>

                            <h:commandLink styleClass="box-action icon" p:data-toggle="modal" p:data-target="#editPlayer"
                                           rendered="#{allPlayersBean.isEditable(profileBean.player)}">
                                <i data-feather="edit-3"></i>
                                <f:ajax execute="@this" render=":modals:editPlayer:footer :modals:editPlayer:body"/>
                                <f:setPropertyActionListener value="#{profileBean.player}" target="#{playerDetailController.player}"/>
                            </h:commandLink>
                        </div>

                        <h:panelGroup layout="block" id="avatar" class="player-box-icon">
                            <h:graphicImage value="#{avatarBean.getAvatar(profileBean.player)}" alt="avatar" />
                        </h:panelGroup>
                        <span class="player-box-name">#{profileBean.player.user.username}</span>

                        <span class="player-box-rank">#{profileBean.player.playerRank}</span>

                    </div>

                    <ui:fragment rendered="#{statUtil.getGamesPlayed(profileBean.player) == 0}">
                        <div class="box not-played">
                            No stats available. #{sessionInfoBean.currentUser.equals(profileBean.player.user) ? 'Play a game to see your stats.' : 'This user has not played yet.'}
                        </div>
                    </ui:fragment>

                    <ui:fragment rendered="#{statUtil.getGamesPlayed(profileBean.player) != 0}">
                        <div class="box profile-stat-box">
                            <qc:stat value="#{profileBean.player.highScore}" label="highscore" />
                            <qc:stat value="#{profileBean.player.lastGameScores[9]}" label="score of last game" />
                            <qc:stat value="#{statUtil.msToString(profileBean.player.playTime)}" label="time played" />
                            <qc:stat value="#{profileBean.player.totalScore}" label="total score" />
                        </div>
                    </ui:fragment>

                    <h:panelGroup layout="block" styleClass="box profile-actions" rendered="#{profileBean.player.user.equals(sessionInfoBean.currentUser)}">
                        <h:commandLink styleClass="btn btn-primary" action="/quizroom/createRoom?faces-redirect=true" value="Create Game">
                            <f:ajax execute="@this" render="@none" />
                        </h:commandLink>

                        <a class="btn btn-primary" href="/quizroom/index.html">Join Game</a>
                    </h:panelGroup>

                    <ui:fragment rendered="#{statUtil.getGamesPlayed(profileBean.player) != 0}">
                        <div class="box profile-stat-box profile-stat-line">
                            <qc:stat value="#{statUtil.roundPercent(profileBean.player.playerAccuracy)}" label="accuracy" />
                            <qc:stat value="#{profileBean.player.totalAnswers}" label="questions answered" />
                            <qc:stat value="#{profileBean.player.correctAnswersCount}" label="correct answers" />
                            <qc:stat value="#{profileBean.player.totalAnswers - profileBean.player.correctAnswersCount}" label="wrong answers" />
                        </div>

                        <fieldset class="box chart">
                            <legend>Last Scores</legend>
                            <div id="area" ></div>
                        </fieldset>
                        <fieldset class="box chart">
                            <legend>Played QuestionSets</legend>
                            <div id="donut"></div>
                        </fieldset>
                    </ui:fragment>

                </h:panelGroup>

                <!-- recently played with players --><!-- TODO heading? -->
                <h:panelGroup layout="block" rendered="#{not empty profileBean.recentlyPlayedWith}" styleClass="collection-header">#{profileBean.player.user.equals(sessionInfoBean.currentUser) ? 'You' : sessionInfoBean.currentUser.username} recently played with</h:panelGroup>
                <h:panelGroup layout="block" styleClass="collection">
                    <ui:repeat value="#{profileBean.recentlyPlayedWith}" var="player">
                        <qc:playerbox player="#{player}">
                            <h:commandLink action="profile?faces-redirect=true" styleClass="ml-2">
                                <i data-feather="info"></i>
                                <f:ajax execute="@this" render="@none"/>
                                <f:setPropertyActionListener value="#{player}" target="#{profileBean.player}"/>
                            </h:commandLink>
                        </qc:playerbox>
                    </ui:repeat>
                </h:panelGroup>

            </ui:fragment>
        </h:form>
    </ui:define>

    <ui:define name="modals">
        <h:form id="modals" enctype="multipart/formdata">
            <ui:fragment rendered="#{profileBean.player != null}">
                <!-- MODAL ACTIONS -->

                <qc:modal id="deletePlayer"
                          target="deletePlayer"
                          title="Delete Player"
                          confirm="Delete Player"
                          confirmButton="btn btn-danger"
                          abortButton="btn btn-secondary"
                          abort="Cancel"
                          confirmAction="#{playerDetailController.deletePlayer}"
                          update="@this">
                    Are you sure? This cannot be undone.
                </qc:modal>

                <qc:modal id="editPlayer"
                          target="editPlayer"
                          title="Edit Password"
                          confirm="Edit Password"
                          abort="Cancel"
                          bodyId="body" footerId="footer"
                          confirmAction="#{playerDetailController.changePassword}"
                          disableConfirm="#{!playerDetailController.passwordValid}"
                          update="@this :modals:editPlayer:footer :modals:editPlayer:body">
                    <h:inputSecret p:placeholder="New password" value="#{playerDetailController.password}" p:autocomplete="new-password" styleClass="form-control">
                        <f:ajax event="keyup" execute="@this" render=":modals:editPlayer:footer"/>
                    </h:inputSecret>
                    <h:inputSecret p:placeholder="Repeat new password" value="#{playerDetailController.repeatPassword}" p:autocomplete="new-password" styleClass="form-control">
                        <f:ajax event="keyup" execute="@this" render=":modals:editPlayer:footer"/>
                    </h:inputSecret>
                </qc:modal>

                <qc:modal id="changeAvatar"
                          target="changeAvatar"
                          title="Change Avatar"
                          closeAction="#{changeAvatarBean.abort}"
                          abortAction="#{changeAvatarBean.abort}"
                          confirmAction="#{changeAvatarBean.saveAvatar}"
                          update="@this :form:avatar :modals:changeAvatar:body :modals:changeAvatar:footer"
                          bodyId="body"
                          footerId="footer"
                          rendered="#{profileBean.player.user.equals(sessionInfoBean.currentUser)}"
                          disableConfirm="#{changeAvatarBean.disabled}">
                    <div jsf:id="preview" class="preview">
                        <h:graphicImage p:id="preview" value="#{avatarBean.getAvatar((changeAvatarBean.filename == null ? profileBean.player.avatarPath : changeAvatarBean.filename), profileBean.player.user.username)}" alt="avatar" />
                    </div>

                    <qc:upload target="#{changeAvatarBean.file}"
                               listener="#{changeAvatarBean.handleFileUpload}"
                               accept="image/*" update=":modals:changeAvatar:body :modals:changeAvatar:footer"
                               text="Upload Avatar" />
                </qc:modal>
            </ui:fragment>

        </h:form>
    </ui:define>

    <ui:define name="site-specific-javascript">
        <ui:fragment rendered="#{statUtil.getGamesPlayed(profileBean.player) != 0}">
            <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
            <script type="text/javascript" src="/resources/pages/profile/stats.js"></script>
        </ui:fragment>
    </ui:define>
</ui:composition>
